services:
  mosquitto:
    build:
      context: ./docker/mosquitto
      dockerfile: Dockerfile
    container_name: iot-mosquitto
    restart: unless-stopped
    ports:
      - "${MQTT_PORT:-1883}:1883"
    volumes:
      - mosquitto-data:/mosquitto/data
      - mosquitto-logs:/mosquitto/log
    networks:
      - iot-network
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  ollama:
    build:
      context: ./docker/ollama
      dockerfile: Dockerfile
    container_name: iot-ollama
    restart: unless-stopped
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama-models:/root/.ollama
    networks:
      - iot-network
    environment:
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen3:0.6b}
      - OLLAMA_PULL_ON_START=${OLLAMA_PULL_ON_START:-true}
      - OLLAMA_HOST=0.0.0.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  app:
    build:
      context: .
      dockerfile: docker/app/Dockerfile
    container_name: iot-app
    restart: unless-stopped
    depends_on:
      mosquitto:
        condition: service_healthy
      ollama:
        condition: service_healthy
    volumes:
      - ./config:/app/config:ro
      - ./rules:/app/rules
      - ./logs:/app/logs
    networks:
      - iot-network
    environment:
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - OLLAMA_HOST=ollama
      - OLLAMA_PORT=11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen3:0.6b}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  iot-network:
    driver: bridge
    name: iot-fuzzy-llm-network

volumes:
  mosquitto-data:
    name: iot-mosquitto-data
  mosquitto-logs:
    name: iot-mosquitto-logs
  ollama-models:
    name: iot-ollama-models
